---
- include_tasks: packages.yml
  when: bbbackend_manage_packages | bool

- import_tasks: repositories.yml
  when: bbbackend_manage_repositories | bool

- name: install bbb and dependencies
  become: true
  apt:
    name: "{{ bbbackend_bbb_and_dependencies }}"
    state: "{{ bbbackend_state }}"

- import_tasks: freeswitch.yml

- meta: flush_handlers

- name: Ensure mongod is started and enabled to start at boot.
  service:
    name: mongod
    enabled: yes
    state: started

- name: Ensure nginx is started and enabled to start at boot.
  service:
    name: nginx
    enabled: yes
    state: started

- name: Check if bbb_ssl_cert exists
  stat:
    path: "{{ bbb_ssl_cert }}"
  register: bbbcert

- import_tasks: letsencrypt.yml
  when: bbb_letsencrypt_enable and not bbbcert.stat.exists

- import_tasks: certificate-selfsigned.yml
  when: not bbb_letsencrypt_enable and not bbbcert.stat.exists

- import_tasks: config.yml

- import_tasks: freeswitch-watchdog.yml
  tags: [freeswitch-watchdog]

- import_tasks: coturn.yml
  when: bbb_coturn_enable
